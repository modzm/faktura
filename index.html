<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PDF z adnotacją i datą</title>
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; max-width: 600px; margin: 2rem auto; padding: 0 1rem; }
  label, input, select, button { display: block; margin: 0.5rem 0; width: 100%; font-size: 1rem; }
  button { padding: 0.5rem; cursor: pointer; }
</style>
</head>
<body>

<h1>PDF z adnotacją i datą</h1>

<label for="pdfFile">Wybierz plik PDF:</label>
<input type="file" id="pdfFile" accept="application/pdf" />

<label for="annotationText">Tekst adnotacji (bez polskich znaków):</label>
<input type="text" id="annotationText" placeholder="Np. NIE PLACIMY" maxlength="50" />

<label for="fontSize">Rozmiar czcionki (px):</label>
<input type="number" id="fontSize" value="14" min="8" max="48" />

<label for="position">Pozycja adnotacji:</label>
<select id="position">
  <option value="top-left">Lewy górny róg</option>
  <option value="top-right" selected>Prawy górny róg</option>
  <option value="bottom-left">Lewy dolny róg</option>
  <option value="bottom-right">Prawy dolny róg</option>
</select>

<label for="pages">Strony do adnotacji (np. 1,3-5, puste = wszystkie):</label>
<input type="text" id="pages" placeholder="np. 1,3-5" />

<button id="processBtn">Dodaj adnotację i datę, pobierz PDF</button>

<script>
  const { PDFDocument, StandardFonts, rgb } = PDFLib;

  function removePolishChars(str) {
    const map = {
      ą:'a', ć:'c', ę:'e', ł:'l', ń:'n', ó:'o', ś:'s', ź:'z', ż:'z',
      Ą:'A', Ć:'C', Ę:'E', Ł:'L', Ń:'N', Ó:'O', Ś:'S', Ź:'Z', Ż:'Z'
    };
    return str.replace(/[ąćęłńóśźżĄĆĘŁŃÓŚŹŻ]/g, c => map[c] || c);
  }

  function parsePages(input, maxPage) {
    if (!input.trim()) return [...Array(maxPage).keys()];
    const parts = input.split(',');
    const pages = new Set();
    parts.forEach(part => {
      if (part.includes('-')) {
        const [start, end] = part.split('-').map(x => parseInt(x.trim(),10));
        for(let i = start; i <= end; i++) {
          if(i > 0 && i <= maxPage) pages.add(i-1);
        }
      } else {
        const pageNum = parseInt(part.trim(), 10);
        if(pageNum > 0 && pageNum <= maxPage) pages.add(pageNum-1);
      }
    });
    return Array.from(pages).sort((a,b)=>a-b);
  }

  function formatDate(date) {
    const dd = String(date.getDate()).padStart(2,'0');
    const mm = String(date.getMonth()+1).padStart(2,'0');
    const yyyy = date.getFullYear();
    return `${dd}/${mm}/${yyyy}`;
  }

  document.getElementById('processBtn').onclick = async () => {
    const fileInput = document.getElementById('pdfFile');
    const textInput = document.getElementById('annotationText');
    const fontSizeInput = document.getElementById('fontSize');
    const positionSelect = document.getElementById('position');
    const pagesInput = document.getElementById('pages');

    if(fileInput.files.length === 0) {
      alert('Wybierz plik PDF!');
      return;
    }
    let text = textInput.value.trim();
    if(text.length === 0) {
      alert('Wpisz tekst adnotacji!');
      return;
    }
    text = removePolishChars(text);

    try {
      const arrayBuffer = await fileInput.files[0].arrayBuffer();
      const pdfDoc = await PDFDocument.load(arrayBuffer);

      const pagesToAnnotate = parsePages(pagesInput.value, pdfDoc.getPageCount());

      const font = await pdfDoc.embedFont(StandardFonts.Helvetica);

      // bieżąca data do wpisania
      const dateText = 'Data przyjecia: ' + formatDate(new Date());
      const dateFontSize = 12;

      pagesToAnnotate.forEach(pageIndex => {
        const page = pdfDoc.getPages()[pageIndex];
        const { width, height } = page.getSize();
        const fontSize = parseInt(fontSizeInput.value, 10);

        // pozycje x,y dla obu tekstów
        let xDate = 10;
        let yDate = height - dateFontSize - 10;
        let xAnn = 10;
        let yAnn = yDate - fontSize - 2; // pod datą

        switch(positionSelect.value) {
          case 'top-left':
            xDate = 10;
            yDate = height - dateFontSize - 10;
            xAnn = 10;
            yAnn = yDate - fontSize - 2;
            break;
          case 'top-right':
            xDate = width - font.widthOfTextAtSize(dateText, dateFontSize) - 10;
            yDate = height - dateFontSize - 10;
            xAnn = width - font.widthOfTextAtSize(text, fontSize) - 10;
            yAnn = yDate - fontSize - 2;
            break;
          case 'bottom-left':
            xAnn = 10;
            yAnn = 10;
            xDate = 10;
            yDate = yAnn + fontSize + 2;
            break;
          case 'bottom-right':
            xAnn = width - font.widthOfTextAtSize(text, fontSize) - 10;
            yAnn = 10;
            xDate = width - font.widthOfTextAtSize(dateText, dateFontSize) - 10;
            yDate = yAnn + fontSize + 2;
            break;
        }

        // wpisujemy datę (czarny)
        page.drawText(dateText, {
          x: xDate,
          y: yDate,
          size: dateFontSize,
          font,
          color: rgb(0,0,0),
          opacity: 1,
        });

        // wpisujemy adnotację (czerwony)
        page.drawText(text, {
          x: xAnn,
          y: yAnn,
          size: fontSize,
          font,
          color: rgb(1,0,0),
          opacity: 0.8,
        });
      });

      const pdfBytes = await pdfDoc.save();
      const originalName = fileInput.files[0].name.replace(/\.pdf$/i, '');
      const newName = originalName + '_adnotacja.pdf';

      const blob = new Blob([pdfBytes], {type: 'application/pdf'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = newName;
      a.click();
      URL.revokeObjectURL(url);

      alert('PDF przetworzony i pobrany');
    } catch(e) {
      alert('Cos poszlo nie tak: ' + e.message);
    }
  }
</script>

</body>
</html>
