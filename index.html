<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>PDF z adnotacją dla naszych przyjaciół</title>
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
</head>
<body>
  <input type="file" id="fileInput" accept="application/pdf" />
  <button id="processBtn">Dodaj adnotację i pobierz</button>

  <script>
    document.getElementById('processBtn').onclick = async () => {
      const input = document.getElementById('fileInput');
      if (!input.files.length) {
        alert('Wybierz plik PDF');
        return;
      }
      const file = input.files[0];
      const arrayBuffer = await file.arrayBuffer();

      const { PDFDocument, StandardFonts, rgb } = PDFLib;

      try {
        const pdfDoc = await PDFDocument.load(arrayBuffer);

        // Użycie wbudowanej czcionki Helvetica
        const helveticaFont = await pdfDoc.embedFont(StandardFonts.Helvetica);

        const pages = pdfDoc.getPages();
        const now = new Date();
        const dateStr = now.toLocaleDateString('pl-PL');

        for (const page of pages) {
          const { width, height } = page.getSize();

          const marginRight = 20;
          const marginTop = 20;

          const text1 = `Data przyjecia: ${dateStr}`;
          const text2 = 'NIE PLACIMY';

          const fontSize1 = 12;
          const fontSize2 = 16;

          const textWidth1 = helveticaFont.widthOfTextAtSize(text1, fontSize1);
          const textWidth2 = helveticaFont.widthOfTextAtSize(text2, fontSize2);

          const x1 = width - textWidth1 - marginRight;
          const x2 = width - textWidth2 - marginRight;

          const y1 = height - marginTop - fontSize1;
          const y2 = height - marginTop - fontSize1 - fontSize2 - 5;

          page.drawText(text1, {
            x: x1,
            y: y1,
            size: fontSize1,
            font: helveticaFont,
            color: rgb(0, 0, 0),
          });

          page.drawText(text2, {
            x: x2,
            y: y2,
            size: fontSize2,
            font: helveticaFont,
            color: rgb(1, 0, 0),
          });
        }

        const pdfBytes = await pdfDoc.save();

        const blob = new Blob([pdfBytes], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;

        const originalName = file.name.replace(/\.pdf$/i, '');
        a.download = `${originalName}_adnotacja.pdf`;

        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch (e) {
        alert('Cos poszlo nie tak: ' + e.message);
      }
    };
  </script>
</body>
</html>
