<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>PDF z adnotacją</title>
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 500px;
      margin: auto;
    }
    input, button {
      font-size: 16px;
      margin-top: 10px;
      display: block;
      width: 100%;
      padding: 8px;
    }
    button {
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h2>Dodaj adnotację do PDF</h2>
  <input type="file" id="fileInput" accept="application/pdf" />
  <button id="processBtn">Dodaj adnotację i pobierz PDF</button>

  <script>
    const { PDFDocument, rgb, StandardFonts, degrees } = PDFLib;
    const fileInput = document.getElementById('fileInput');
    const processBtn = document.getElementById('processBtn');

    processBtn.onclick = async () => {
      if (fileInput.files.length === 0) {
        alert('Wczytaj plik PDF!');
        return;
      }

      try {
        const file = fileInput.files[0];
        const arrayBuffer = await file.arrayBuffer();

        const pdfDoc = await PDFDocument.load(arrayBuffer);
        const pages = pdfDoc.getPages();
        const font = await pdfDoc.embedFont(StandardFonts.HelveticaBold);

        const dateStr = new Date().toLocaleDateString('pl-PL');

        pages.forEach(page => {
          const { width, height } = page.getSize();

          // Data przyjęcia w prawym górnym rogu
          page.drawText(`Data przyjęcia: ${dateStr}`, {
            x: width - 200,
            y: height - 30,
            size: 12,
            font,
            color: rgb(0, 0, 0),
          });

          // Adnotacja "NIE PŁACIMY" czerwoną czcionką trochę niżej
          page.drawText('NIE PŁACIMY', {
            x: width - 150,
            y: height - 50,
            size: 14,
            font,
            color: rgb(1, 0, 0),
            rotate: degrees(0),
          });
        });

        const pdfBytes = await pdfDoc.save();

        // Poprawione pobieranie pliku:
        const blob = new Blob([pdfBytes], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `z_annotacja_${dateStr.replace(/\./g, '-')}.pdf`;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }, 100);

      } catch (e) {
        alert('Coś poszło nie tak: ' + e.message);
      }
    };
  </script>
</body>
</html>
